<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Dinner Menu | Interactive Planner</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Markdown Parser for AI Responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdfbf7;
            color: #333;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container { height: 350px; }
        }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        .selected-card {
            border: 2px solid #ea580c;
            background-color: #fff7ed;
            transform: scale(1.02);
            transition: all 0.2s ease-in-out;
        }
        .sparkle-spin { animation: spin 2s linear infinite; }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* WEEKLY PRINT STYLES */
        #print-view { display: none; }
        
        @media print {
            body > * { display: none !important; }
            body { background: white !important; }
            
            /* If Recipe Modal is open, print that */
            body:has(#recipe-modal:not(.hidden)) #recipe-modal {
                display: block !important;
                position: static !important;
                width: 100% !important;
                height: auto !important;
            }
            body:has(#recipe-modal:not(.hidden)) #recipe-modal button { display: none !important; }
            body:has(#recipe-modal:not(.hidden)) #modal-content { overflow: visible !important; }

            /* If Recipe Modal is CLOSED, print the Weekly Menu */
            body:not(:has(#recipe-modal:not(.hidden))) #print-view {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                padding: 2rem;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-stone-200 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-orange-100 p-2 rounded-lg text-2xl">üìñ</div>
                <div>
                    <h1 class="text-xl font-bold text-stone-800">The Dinner Menu</h1>
                    <p class="text-xs text-stone-500">Interactive Meal Planner</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.print()" class="text-stone-500 hover:text-stone-800 px-3 py-2 rounded-lg transition border border-stone-200 hover:bg-stone-50 text-sm font-medium shadow-sm flex items-center gap-2" title="Print Weekly Plan">
                    <span>üñ®Ô∏è</span> <span class="hidden sm:inline">Print Week</span>
                </button>
                <button onclick="openSettings()" class="text-stone-500 hover:text-stone-800 px-3 py-2 rounded-lg transition border border-stone-200 hover:bg-stone-50 text-sm font-medium shadow-sm flex items-center gap-2" title="API Settings">
                    <span>‚öôÔ∏è</span> <span class="hidden sm:inline">Settings</span>
                </button>
                <!-- Reset button now clears current day only, maybe add full reset logic later -->
                <button onclick="resetDay()" class="text-stone-500 hover:text-stone-800 px-3 py-2 rounded-lg transition border border-stone-200 hover:bg-stone-50 text-sm font-medium shadow-sm flex items-center gap-1" title="Clear Current Day">
                    <span>üóëÔ∏è</span> Clear Day
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 flex-grow space-y-8">
        <!-- Intro -->
        <section class="max-w-4xl mx-auto text-center">
            <p class="text-stone-600">
                Welcome to your <strong>Weekly Planner</strong>. Select a Day below, then fill your plate.
            </p>
        </section>

        <!-- DAY SELECTOR TABS -->
        <section class="max-w-4xl mx-auto">
            <div class="flex justify-center gap-2 bg-white p-2 rounded-xl shadow-sm border border-stone-200 overflow-x-auto">
                <button onclick="selectDay('Mon')" id="day-Mon" class="day-tab flex-1 px-6 py-3 rounded-lg font-bold text-sm transition-all bg-stone-800 text-white shadow-md">Mon</button>
                <button onclick="selectDay('Tue')" id="day-Tue" class="day-tab flex-1 px-6 py-3 rounded-lg font-bold text-sm text-stone-500 hover:bg-stone-100 transition-all">Tue</button>
                <button onclick="selectDay('Wed')" id="day-Wed" class="day-tab flex-1 px-6 py-3 rounded-lg font-bold text-sm text-stone-500 hover:bg-stone-100 transition-all">Wed</button>
                <button onclick="selectDay('Thu')" id="day-Thu" class="day-tab flex-1 px-6 py-3 rounded-lg font-bold text-sm text-stone-500 hover:bg-stone-100 transition-all">Thu</button>
                <button onclick="selectDay('Fri')" id="day-Fri" class="day-tab flex-1 px-6 py-3 rounded-lg font-bold text-sm text-stone-500 hover:bg-stone-100 transition-all">Fri</button>
            </div>
        </section>

        <!-- Plate Builder (Context Aware) -->
        <section class="bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden relative">
            <div class="bg-stone-50 px-6 py-3 border-b border-stone-200 flex justify-between items-center">
                <h2 class="font-bold text-stone-700">üçΩÔ∏è <span id="current-day-label">Monday</span>'s Dinner</h2>
                <span class="text-xs text-stone-400">Powered by Gemini AI (or Google Search)</span>
            </div>
            
            <div class="p-6 grid grid-cols-1 md:grid-cols-3 gap-6 items-stretch">
                <!-- Main Slot -->
                <div id="main-slot" class="border-2 border-dashed border-stone-300 rounded-xl p-6 flex flex-col items-center justify-center text-center min-h-[12rem] transition-all bg-stone-50 relative group">
                    <span class="text-4xl mb-3 opacity-30">üçó</span>
                    <h3 class="text-lg font-medium text-stone-400">Select Main</h3>
                    <p class="text-xs text-stone-400">From "Mains" tab</p>
                </div>
                <!-- Side Slot -->
                <div id="side-slot" class="border-2 border-dashed border-stone-300 rounded-xl p-6 flex flex-col items-center justify-center text-center min-h-[12rem] transition-all bg-stone-50 relative">
                    <span class="text-4xl mb-3 opacity-30">ü•ó</span>
                    <h3 class="text-lg font-medium text-stone-400">Select Side</h3>
                    <p class="text-xs text-stone-400">From "Sides" tab</p>
                </div>
                <!-- Sweet Slot -->
                <div id="sweet-slot" class="border-2 border-dashed border-stone-300 rounded-xl p-6 flex flex-col items-center justify-center text-center min-h-[12rem] transition-all bg-stone-50 relative">
                    <span class="text-4xl mb-3 opacity-30">üç™</span>
                    <h3 class="text-lg font-medium text-stone-400">Something Sweet</h3>
                    <p class="text-xs text-stone-400">From "Sweets" tab</p>
                </div>
            </div>
            <!-- Summary Bar -->
            <div id="meal-summary" class="bg-orange-50 px-6 py-3 text-orange-800 text-sm font-medium flex justify-between hidden">
                <span id="total-time-display">Total Est. Time: --</span>
                <span id="energy-display">Energy Required: --</span>
            </div>
        </section>

        <!-- Menu Browser -->
        <section class="bg-white rounded-2xl shadow-sm border border-stone-200 min-h-[600px] flex flex-col">
            <div class="flex flex-wrap border-b border-stone-200">
                <button onclick="switchTab('mains')" id="tab-mains" class="px-6 py-4 font-medium text-stone-600 hover:bg-stone-50 border-b-2 border-transparent transition-colors active-tab">üçó Mains</button>
                <button onclick="switchTab('sides')" id="tab-sides" class="px-6 py-4 font-medium text-stone-600 hover:bg-stone-50 border-b-2 border-transparent transition-colors">ü•ó Sides</button>
                <button onclick="switchTab('sweets')" id="tab-sweets" class="px-6 py-4 font-medium text-stone-600 hover:bg-stone-50 border-b-2 border-transparent transition-colors">üç™ Sweets</button>
                <button onclick="switchTab('ideas')" id="tab-ideas" class="px-6 py-4 font-medium text-stone-600 hover:bg-stone-50 border-b-2 border-transparent transition-colors">üí° Ideas</button>
                <button onclick="switchTab('emergency')" id="tab-emergency" class="px-6 py-4 font-medium text-red-600 hover:bg-red-50 border-b-2 border-transparent transition-colors">üßä Emergency</button>
            </div>
            <div class="p-6 flex-grow bg-stone-50/50">
                <div id="content-mains" class="tab-content block">
                    <div class="flex flex-wrap gap-3 mb-6">
                        <span class="text-sm font-medium text-stone-500 self-center mr-2">Filter:</span>
                        <button onclick="filterMains('all')" class="filter-btn bg-stone-800 text-white px-3 py-1 rounded-full text-xs transition">All</button>
                        <button onclick="filterMains('Low')" class="filter-btn bg-white text-stone-600 border border-stone-200 hover:bg-green-50 px-3 py-1 rounded-full text-xs transition">‚ö°Ô∏è Low</button>
                        <button onclick="filterMains('Med')" class="filter-btn bg-white text-stone-600 border border-stone-200 hover:bg-yellow-50 px-3 py-1 rounded-full text-xs transition">‚öñÔ∏è Med</button>
                        <button onclick="filterMains('Slow')" class="filter-btn bg-white text-stone-600 border border-stone-200 hover:bg-orange-50 px-3 py-1 rounded-full text-xs transition">üõãÔ∏è Slow</button>
                        <button onclick="filterMains('Pizza')" class="filter-btn bg-white text-stone-600 border border-stone-200 hover:bg-red-50 px-3 py-1 rounded-full text-xs transition">üçï Pizza</button>
                    </div>
                    <div id="mains-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
                <div id="content-sides" class="tab-content hidden">
                    <div id="sides-grid" class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                </div>
                <div id="content-sweets" class="tab-content hidden">
                    <div id="sweets-grid" class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                </div>
                <div id="content-ideas" class="tab-content hidden">
                    <div id="ideas-list" class="space-y-3"></div>
                </div>
                <div id="content-emergency" class="tab-content hidden">
                    <div id="emergency-list" class="max-w-md mx-auto space-y-4"></div>
                </div>
            </div>
        </section>
        
        <!-- Analytics (Kept at bottom for weekly overview later) -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 opacity-60 hover:opacity-100 transition-opacity">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                <h3 class="font-bold text-stone-700 mb-4 text-center">Master Menu Balance</h3>
                <div class="chart-container"><canvas id="energyChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-stone-200">
                <h3 class="font-bold text-stone-700 mb-4 text-center">Cook Times</h3>
                <div class="chart-container"><canvas id="timeChart"></canvas></div>
            </div>
        </section>
    </main>

    <!-- RECIPE MODAL -->
    <div id="recipe-modal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl">
            <div class="p-6 border-b border-stone-100 flex justify-between items-center bg-stone-50 rounded-t-2xl">
                <h3 id="modal-title" class="text-xl font-bold text-stone-800">Recipe</h3>
                <div class="flex items-center gap-2">
                    <button onclick="printRecipe()" class="text-stone-500 hover:text-stone-800 px-3 py-1 rounded border border-stone-200 text-sm flex items-center gap-1 hover:bg-stone-50">
                        <span>üñ®Ô∏è</span> Print
                    </button>
                    <button onclick="closeModal()" class="text-stone-400 hover:text-stone-600 text-2xl ml-2">&times;</button>
                </div>
            </div>
            <div id="modal-content" class="p-8 overflow-y-auto custom-scroll prose prose-stone max-w-none"></div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl p-6">
            <h3 class="text-xl font-bold text-stone-800 mb-4">‚öôÔ∏è App Settings</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-stone-700 mb-1">Google Gemini API Key</label>
                <input type="password" id="api-key-input" placeholder="Paste your AIza... key here" class="w-full p-2 border border-stone-300 rounded-lg text-sm">
                <p class="text-xs text-stone-400 mt-1">Stored securely in your browser's local storage.<br><strong>Leave blank to use Google Search fallback.</strong></p>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeSettings()" class="px-4 py-2 text-stone-500 hover:text-stone-700">Cancel</button>
                <button onclick="saveSettings()" class="bg-stone-800 text-white px-4 py-2 rounded-lg hover:bg-stone-700">Save</button>
            </div>
        </div>
    </div>

    <!-- PRINT VIEW CONTAINER (Hidden normally, visible on Print) -->
    <div id="print-view" class="bg-white">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-stone-800">Weekly Dinner Plan</h1>
            <p class="text-stone-500">Cook Twice, Eat All Week</p>
        </div>
        <div class="grid gap-4" id="print-grid">
            <!-- Populated by JS -->
        </div>
    </div>

    <script>
        // --- DATA ---
        const mainsData = [
            { id: 'm1', name: "Thai Coconut Curry Soup", time: 20, timeDisplay: "20 min", energy: "Low", icon: "‚ö°Ô∏è", notes: "Turkey Sub", category: "Low" },
            { id: 'm2', name: "One-Pan Cheesy Tortilla Melts", time: 25, timeDisplay: "25 min", energy: "Low", icon: "‚ö°Ô∏è", notes: "", category: "Low" },
            { id: 'm3', name: "Mozzarella & Herb Chicken", time: 30, timeDisplay: "30 min", energy: "Med", icon: "‚öñÔ∏è", notes: "", category: "Med" },
            { id: 'm4', name: "Soy-Glazed Hoisin Meatloaves", time: 40, timeDisplay: "40 min", energy: "Med", icon: "‚öñÔ∏è", notes: "", category: "Med" },
            { id: 'm5', name: "Onion Crunch Chicken", time: 40, timeDisplay: "40 min", energy: "Med", icon: "‚öñÔ∏è", notes: "", category: "Med" },
            { id: 'm6', name: "Korean Glazed Meatloaf", time: 45, timeDisplay: "~45 min", energy: "Med", icon: "‚öñÔ∏è", notes: "", category: "Med" },
            { id: 'm7', name: "Patrick‚Äôs Famous Chili", time: 120, timeDisplay: "Simmer", energy: "Slow/Comfort", icon: "üõãÔ∏è", notes: "", category: "Slow" },
            { id: 'm8', name: "Patrick‚Äôs Potato Soup", time: 240, timeDisplay: "Slow Cooker", energy: "Slow/Comfort", icon: "üõãÔ∏è", notes: "", category: "Slow" },
            { id: 'm9', name: "Patrick‚Äôs Corn Chowder", time: 120, timeDisplay: "Simmer", energy: "Slow/Comfort", icon: "üõãÔ∏è", notes: "", category: "Slow" },
            { id: 'm10', name: "Beef Roast Dinner", time: 420, timeDisplay: "Slow Cooker", energy: "Slow/Comfort", icon: "üõãÔ∏è", notes: "", category: "Slow" },
            { id: 'm11', name: "Homemade Pizza", time: 15, timeDisplay: "15 min", energy: "Tradition", icon: "üçï", notes: "Friday Tradition", category: "Pizza" }
        ];

        const sidesData = ["Steamed Broccoli", "Mashed Sweet Potatoes", "Roasted Carrots (425¬∞F)", "Roasted Green Beans", "Buttery Couscous", "Jasmine Rice"];
        const sweetsData = ["Whipped Shortbread", "Dark Chocolate", "Berries & Cream", "Frozen Yoghurt", "Fruit Salad"];

        const newIdeasData = [
            { name: "Vegan Taco Soup", meta: "30 min, Quinoa & Black Beans" },
            { name: "Caramelized Onion, Steak & Cheese Skillet", meta: "Philly cheesesteak vibes" },
            { name: "Coconut Curry Lentil Veggie Stew", meta: "Meatless, similar to Thai soup" },
            { name: "Sheet-Pan Chimichurri Fish", meta: "30 min, light" },
            { name: "Shortcut Shakshuka with Feta", meta: "15 min, breakfast-for-dinner" }
        ];
        const emergencyData = ["Morning Star Chicken Patties"];

        // --- STATE ---
        let currentDay = 'Mon';
        // Initialize 5-day plan
        let weeklyPlan = {
            'Mon': { main: null, side: null, sweet: null },
            'Tue': { main: null, side: null, sweet: null },
            'Wed': { main: null, side: null, sweet: null },
            'Thu': { main: null, side: null, sweet: null },
            'Fri': { main: null, side: null, sweet: null }
        };
        let filter = 'all';

        // --- DOM ---
        const mainsGrid = document.getElementById('mains-grid');
        const sidesGrid = document.getElementById('sides-grid');
        const sweetsGrid = document.getElementById('sweets-grid');
        const ideasList = document.getElementById('ideas-list');
        const emergencyList = document.getElementById('emergency-list');
        const mainSlot = document.getElementById('main-slot');
        const sideSlot = document.getElementById('side-slot');
        const sweetSlot = document.getElementById('sweet-slot');
        const mealSummary = document.getElementById('meal-summary');
        const totalTimeDisplay = document.getElementById('total-time-display');
        const energyDisplay = document.getElementById('energy-display');
        const modal = document.getElementById('recipe-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const currentDayLabel = document.getElementById('current-day-label');
        const printGrid = document.getElementById('print-grid');

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadPlanFromStorage();
            renderAllTabs();
            selectDay('Mon');
            initCharts();
            
            // Check for saved key
            const savedKey = localStorage.getItem('dinner_menu_gemini_key');
            if(savedKey) apiKeyInput.value = savedKey;
        });

        function loadPlanFromStorage() {
            const saved = localStorage.getItem('weekly_dinner_plan');
            if(saved) weeklyPlan = JSON.parse(saved);
        }

        function savePlanToStorage() {
            localStorage.setItem('weekly_dinner_plan', JSON.stringify(weeklyPlan));
            updatePrintView();
        }

        // --- DAY SELECTION LOGIC ---
        function selectDay(day) {
            currentDay = day;
            
            // Update Day Tabs UI
            document.querySelectorAll('.day-tab').forEach(btn => {
                if(btn.id === `day-${day}`) {
                    btn.classList.add('bg-stone-800', 'text-white', 'shadow-md');
                    btn.classList.remove('text-stone-500', 'hover:bg-stone-100');
                } else {
                    btn.classList.remove('bg-stone-800', 'text-white', 'shadow-md');
                    btn.classList.add('text-stone-500', 'hover:bg-stone-100');
                }
            });

            // Update Labels
            const fullDays = {'Mon':'Monday', 'Tue':'Tuesday', 'Wed':'Wednesday', 'Thu':'Thursday', 'Fri':'Friday'};
            currentDayLabel.textContent = fullDays[day];

            // Render existing selection for this day
            renderPlateBuilder();
            // Re-render grids to highlight current selection
            renderAllTabs();
        }

        function renderPlateBuilder() {
            const plan = weeklyPlan[currentDay];
            
            // Main
            if(plan.main) {
                mainSlot.className = "bg-white border-2 border-orange-500 rounded-xl p-6 flex flex-col items-center justify-center text-center min-h-[12rem] shadow-sm transition-all";
                mainSlot.innerHTML = `
                    <span class="text-4xl mb-2">${plan.main.icon}</span>
                    <h3 class="text-xl font-bold text-stone-800 leading-tight mb-2">${plan.main.name}</h3>
                    <p class="text-sm text-stone-500 mb-4">Est: ${plan.main.timeDisplay}</p>
                    <button onclick="generateRecipe()" class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-sm font-medium px-4 py-2 rounded-full hover:shadow-lg transition flex items-center gap-2 transform hover:scale-105">‚ú® Recipe</button>
                `;
            } else {
                mainSlot.className = "border-2 border-dashed border-stone-300 rounded-xl p-6 flex flex-col items-center justify-center text-center min-h-[12rem] transition-all bg-stone-50 relative group";
                mainSlot.innerHTML = `<span class="text-4xl mb-3 opacity-30">üçó</span><h3 class="text-lg font-medium text-stone-400">Select Main</h3><p class="text-xs text-stone-400">From "Mains" tab</p>`;
            }

            // Side
            if(plan.side) {
                sideSlot.className = "bg-white border-2 border-green-500 rounded-xl p-6 flex flex-col items-center justify-center text-center min-h-[12rem] shadow-sm transition-all";
                sideSlot.innerHTML = `
                    <span class="text-4xl mb-2">ü•ó</span>
                    <h3 class="text-xl font-bold text-stone-800 leading-tight mb-4">${plan.side}</h3>
                    <button onclick="suggestSide()" class="text-xs text-purple-600 font-medium hover:underline flex items-center gap-1">‚ú® Ask AI</button>
                `;
            } else {
                sideSlot.className = "border-2 border-dashed border-stone-300 rounded-xl p-6 flex flex-col items-center justify-center text-center min-h-[12rem] transition-all bg-stone-50 relative";
                sideSlot.innerHTML = `<span class="text-4xl mb-3 opacity-30">ü•ó</span><h3 class="text-lg font-medium text-stone-400">Select Side</h3><p class="text-xs text-stone-400">From "Sides" tab</p>`;
            }

            // Sweet
            if(plan.sweet) {
                sweetSlot.className = "bg-white border-2 border-pink-500 rounded-xl p-6 flex flex-col items-center justify-center text-center min-h-[12rem] shadow-sm transition-all";
                sweetSlot.innerHTML = `<span class="text-4xl mb-2">üç™</span><h3 class="text-xl font-bold text-pink-700 leading-tight mb-2">${plan.sweet}</h3><button onclick="selectSweet(null)" class="text-xs text-stone-400 underline">Remove</button>`;
            } else {
                sweetSlot.className = "border-2 border-dashed border-stone-300 rounded-xl p-6 flex flex-col items-center justify-center text-center min-h-[12rem] transition-all bg-stone-50 relative";
                sweetSlot.innerHTML = `<span class="text-4xl mb-3 opacity-30">üç™</span><h3 class="text-lg font-medium text-stone-400">Something Sweet</h3><p class="text-xs text-stone-400">From "Sweets" tab</p>`;
            }

            updateSummary();
        }

        // --- SELECTION LOGIC ---
        function selectMain(dish) {
            weeklyPlan[currentDay].main = dish;
            savePlanToStorage();
            renderPlateBuilder();
            renderMains(); // Update grid highlight
        }

        function selectSide(side) {
            weeklyPlan[currentDay].side = side;
            savePlanToStorage();
            renderPlateBuilder();
            renderSides();
        }

        function selectSweet(sweet) {
            weeklyPlan[currentDay].sweet = sweet;
            savePlanToStorage();
            renderPlateBuilder();
            renderSweets();
        }

        function resetDay() {
            weeklyPlan[currentDay] = { main: null, side: null, sweet: null };
            savePlanToStorage();
            renderPlateBuilder();
            renderAllTabs();
        }

        function resetPlanner() {
            // Full Reset (Optional usage)
            if(confirm("Clear the entire week?")) {
                Object.keys(weeklyPlan).forEach(day => weeklyPlan[day] = { main: null, side: null, sweet: null });
                savePlanToStorage();
                resetDay(); // re-renders current
            }
        }

        // --- RENDERING TABS ---
        function renderAllTabs() {
            renderMains(); renderSides(); renderSweets(); renderIdeas(); renderEmergency();
        }

        function renderMains() {
            mainsGrid.innerHTML = '';
            const filtered = filter === 'all' ? mainsData : mainsData.filter(m => m.category === filter);
            filtered.forEach(dish => {
                const card = document.createElement('div');
                const isSelected = weeklyPlan[currentDay].main?.id === dish.id;
                card.className = `bg-white border border-stone-200 rounded-xl p-4 cursor-pointer hover:shadow-md transition group ${isSelected ? 'selected-card' : ''}`;
                card.onclick = () => selectMain(dish);
                let colorClass = dish.category === 'Low' ? 'bg-green-400' : dish.category === 'Med' ? 'bg-amber-400' : dish.category === 'Slow' ? 'bg-orange-400' : 'bg-red-400';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2"><div class="flex items-center gap-2"><span class="text-xl">${dish.icon}</span><span class="text-xs font-bold px-2 py-0.5 rounded-full bg-stone-100 text-stone-600">${dish.energy}</span></div><div class="w-2 h-2 rounded-full ${colorClass}"></div></div>
                    <h3 class="font-bold text-stone-800 mb-1 group-hover:text-orange-700 transition">${dish.name}</h3>
                    <div class="flex justify-between items-end mt-2"><span class="text-xs text-stone-500 font-mono">‚è± ${dish.timeDisplay}</span></div>
                `;
                mainsGrid.appendChild(card);
            });
        }

        function renderSides() {
            sidesGrid.innerHTML = '';
            sidesData.forEach(side => {
                const card = document.createElement('div');
                const isSelected = weeklyPlan[currentDay].side === side;
                card.className = `bg-white border border-stone-200 rounded-lg p-3 cursor-pointer hover:bg-green-50 hover:border-green-200 transition text-center ${isSelected ? 'border-green-500 bg-green-50 ring-1 ring-green-500' : ''}`;
                card.onclick = () => selectSide(side);
                card.innerHTML = `<span class="text-sm font-medium text-stone-700">${side}</span>`;
                sidesGrid.appendChild(card);
            });
        }
        
        function renderSweets() {
            sweetsGrid.innerHTML = '';
            sweetsData.forEach(sweet => {
                const card = document.createElement('div');
                const isSelected = weeklyPlan[currentDay].sweet === sweet;
                card.className = `bg-white border border-stone-200 rounded-lg p-3 text-center cursor-pointer hover:bg-pink-50 hover:border-pink-200 transition ${isSelected ? 'border-pink-500 bg-pink-50 ring-1 ring-pink-500' : ''}`;
                card.onclick = () => selectSweet(sweet);
                card.innerHTML = `<span class="text-sm font-medium text-stone-700">${sweet}</span>`;
                sweetsGrid.appendChild(card);
            });
        }

        function renderIdeas() {
            ideasList.innerHTML = '';
            newIdeasData.forEach(idea => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white border border-stone-200 p-4 rounded-lg';
                item.innerHTML = `<div><h4 class="font-bold text-stone-800">${idea.name}</h4><p class="text-xs text-stone-500">${idea.meta}</p></div>`;
                ideasList.appendChild(item);
            });
        }

        function renderEmergency() {
            emergencyList.innerHTML = '';
            emergencyData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded shadow-sm border border-red-200 font-bold text-stone-700';
                div.textContent = item;
                emergencyList.appendChild(div);
            });
        }

        function updatePrintView() {
            printGrid.innerHTML = '';
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            const fullDays = {'Mon':'Monday', 'Tue':'Tuesday', 'Wed':'Wednesday', 'Thu':'Thursday', 'Fri':'Friday'};
            
            days.forEach(day => {
                const plan = weeklyPlan[day];
                if(plan.main || plan.side || plan.sweet) {
                    const row = document.createElement('div');
                    row.className = 'flex border-b border-stone-200 py-4 break-inside-avoid';
                    row.innerHTML = `
                        <div class="w-32 font-bold text-stone-800 text-xl">${fullDays[day]}</div>
                        <div class="flex-1">
                            <div class="font-bold text-lg text-stone-900">${plan.main ? plan.main.name : '<span class="text-stone-300 italic">No Main</span>'}</div>
                            <div class="text-stone-600">${plan.side ? '+ ' + plan.side : ''}</div>
                            ${plan.sweet ? `<div class="text-pink-600 text-sm mt-1">üç™ ${plan.sweet}</div>` : ''}
                        </div>
                        <div class="w-24 text-right text-sm text-stone-500">
                            ${plan.main ? plan.main.timeDisplay : ''}
                        </div>
                    `;
                    printGrid.appendChild(row);
                }
            });
            
            if(printGrid.children.length === 0) {
                printGrid.innerHTML = '<div class="text-center text-stone-400 py-10">Plan is empty. Go select some meals!</div>';
            }
        }

        function updateSummary() {
            const plan = weeklyPlan[currentDay];
            if (plan.main) {
                mealSummary.classList.remove('hidden');
                totalTimeDisplay.textContent = `Total Est. Time: ${plan.main.timeDisplay} + Sides`;
                energyDisplay.textContent = `Energy Required: ${plan.main.energy}`;
            } else {
                mealSummary.classList.add('hidden');
            }
        }

        function filterMains(category) {
            filter = category;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.textContent.includes(category) || (category === 'all' && btn.textContent === 'All')) {
                    btn.classList.add('bg-stone-800', 'text-white'); btn.classList.remove('bg-white', 'text-stone-600');
                } else {
                    btn.classList.remove('bg-stone-800', 'text-white'); btn.classList.add('bg-white', 'text-stone-600');
                }
            });
            renderMains();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`content-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('button[id^="tab-"]').forEach(btn => { btn.classList.remove('border-stone-800', 'text-stone-800', 'bg-stone-50'); btn.classList.add('border-transparent'); });
            const activeBtn = document.getElementById(`tab-${tabId}`);
            activeBtn.classList.remove('border-transparent'); activeBtn.classList.add('border-stone-800', 'text-stone-800', 'bg-stone-50');
        }

        function randomizeMeal() {
            const randomMain = mainsData[Math.floor(Math.random() * mainsData.length)];
            const randomSide = sidesData[Math.floor(Math.random() * sidesData.length)];
            const randomSweet = sweetsData[Math.floor(Math.random() * sweetsData.length)];
            
            weeklyPlan[currentDay] = { main: randomMain, side: randomSide, sweet: randomSweet };
            savePlanToStorage();
            renderPlateBuilder();
            renderAllTabs();
            switchTab('mains');
        }

        function printRecipe() {
            window.print();
        }

        // --- GEMINI & SETTINGS ---
        function openSettings() { settingsModal.classList.remove('hidden'); }
        function closeSettings() { settingsModal.classList.add('hidden'); }
        function saveSettings() {
            const key = apiKeyInput.value.trim();
            if(key) {
                localStorage.setItem('dinner_menu_gemini_key', key);
                closeSettings();
                alert("API Key saved securely to this browser.");
            } else {
                localStorage.removeItem('dinner_menu_gemini_key');
                closeSettings();
                alert("API Key removed. Fallback mode active.");
            }
        }

        async function generateRecipe() {
            const plan = weeklyPlan[currentDay];
            if (!plan.main) return;
            const key = localStorage.getItem('dinner_menu_gemini_key');
            
            if (!key) { 
                const query = encodeURIComponent(`recipe for ${plan.main.name} ${plan.main.notes || ''}`);
                window.open(`https://www.google.com/search?q=${query}`, '_blank');
                return; 
            }

            modal.classList.remove('hidden');
            modalContent.innerHTML = `<div class="flex flex-col items-center justify-center py-12"><div class="text-4xl mb-4 sparkle-spin">‚ú®</div><p class="text-stone-500 animate-pulse">Consulting the digital chef...</p></div>`;
            modalTitle.textContent = "Generating...";

            const prompt = `Generate a concise recipe card for "${plan.main.name}". Notes: "${plan.main.notes}". Energy Level: ${plan.main.energy}. Format as Markdown.`;
            const result = await callGemini(prompt, key);
            
            if (result) {
                modalTitle.textContent = `Recipe: ${plan.main.name}`;
                modalContent.innerHTML = marked.parse(result);
            } else {
                modalContent.innerHTML = `<p class="text-red-500 text-center">API Error. Check your key.</p>`;
            }
        }

        async function suggestSide() {
            const plan = weeklyPlan[currentDay];
            if (!plan.main) return;
            const key = localStorage.getItem('dinner_menu_gemini_key');
            
            if (!key) { 
                const query = encodeURIComponent(`best side dish pairing for ${plan.main.name}`);
                window.open(`https://www.google.com/search?q=${query}`, '_blank');
                return; 
            }

            // Using Side Slot as loading indicator
            const originalContent = sideSlot.innerHTML;
            sideSlot.innerHTML = `<div class="flex flex-col items-center"><div class="text-2xl mb-2 sparkle-spin">‚ú®</div><p class="text-xs text-stone-500">Thinking...</p></div>`;

            const prompt = `Suggest ONE perfect side dish for "${plan.main.name}". Return ONLY the side name on line 1 and a 1-sentence reason on line 2.`;
            const result = await callGemini(prompt, key);

            if (result) {
                const lines = result.split('\n').filter(line => line.trim() !== '');
                const sideName = lines[0] || "Garlic Bread";
                const reason = lines[1] || "It goes well with everything.";
                
                weeklyPlan[currentDay].side = sideName;
                savePlanToStorage();
                renderPlateBuilder();
                renderSides();
            } else {
                sideSlot.innerHTML = originalContent;
                alert("AI Error. Check your key.");
            }
        }

        async function callGemini(prompt, key) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            } catch (e) { return null; }
        }

        function closeModal() { modal.classList.add('hidden'); }
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        // --- CHARTS ---
        function initCharts() {
            const ctxEnergy = document.getElementById('energyChart').getContext('2d');
            new Chart(ctxEnergy, { type: 'doughnut', data: { labels: ['Low', 'Med', 'Slow', 'Pizza'], datasets: [{ data: [2, 4, 4, 1], backgroundColor: ['#4ade80', '#fbbf24', '#fb923c', '#f87171'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });

            const ctxTime = document.getElementById('timeChart').getContext('2d');
            new Chart(ctxTime, { type: 'bar', data: { labels: ['Thai Soup', 'Tortilla', 'Mozz Chx', 'Soy Meatloaves', 'Onion Chx', 'Korean Loaf', 'Chili', 'Potato Soup', 'Corn Chowder', 'Beef Roast'], datasets: [{ label: 'Minutes', data: [20, 25, 30, 40, 40, 45, 120, 240, 120, 420], backgroundColor: '#a8a29e', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } } });
        }
    </script>
</body>
</html>
